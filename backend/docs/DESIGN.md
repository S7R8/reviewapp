# ReviewApp - 設計ドキュメント

**最終更新**: 2024年度

---

## 📊 システム概要

### コアコンセプト
**「使えば使うほど、あなたらしくなるAIアシスタント」**

RAGベースのコードレビューツール。ユーザーのコーディング哲学を学習し、一貫性のある「あなたらしい」レビューを提供します。

### 差別化ポイント
1. **ナレッジによる一貫性** - 過去の判断基準を常に参照
2. **成長するAI** - 使うほど賢くなる
3. **あなたのクローン** - 「あなただったらこう言う」レビュー

---

## 🏗️ アーキテクチャ

### レイヤー構成

```
┌─────────────────────────────────┐
│  Interfaces層 (API)              │  ← HTTP Handler, Router, Middleware
├─────────────────────────────────┤
│  Application層 (UseCase)         │  ← ビジネスユースケース
├─────────────────────────────────┤
│  Domain層 (Core)                 │  ← エンティティ, リポジトリIF, ドメインサービス
├─────────────────────────────────┤
│  Infrastructure層                │  ← DB, Claude API ✅, RAG ✅
└─────────────────────────────────┘
```

### 技術スタック

| カテゴリ | 技術 | 理由 |
|---------|------|------|
| **言語** | Go 1.25.2 | 型安全、高速、保守性 |
| **Webフレームワーク** | Echo v4 | 軽量、高速 |
| **DB** | PostgreSQL 15 + pgvector | ベクトル検索対応 |
| **キャッシュ** | Redis 7 | セッション、キャッシュ |
| **LLM** | Claude 3.5 Sonnet | 高精度、長いコンテキスト ✅ |
| **Embedding** | OpenAI text-embedding-3-small | 安価、高精度 (Phase 2) |
| **DI** | Wire | 依存性注入の自動化 |
| **マイグレーション** | SQL | シンプル、バージョン管理 |

---

## 🗄️ データベース設計

### ER図

```
users (ユーザー)
  ├─→ knowledge (ナレッジ) ←→ tags (タグ)
  │     ↓
  └─→ reviews (レビュー履歴)
          ↓
        review_knowledge (参照ナレッジ)
```

### テーブル一覧

1. **users** - ユーザー情報
2. **knowledge** - ナレッジ（コア）
   - Phase 1: 全文検索インデックス
   - Phase 2: vector型 + HNSWインデックス
3. **tags** - タグマスタ
4. **knowledge_tags** - ナレッジ×タグ（N:N）
5. **reviews** - レビュー履歴
6. **review_knowledge** - レビュー×ナレッジ（N:N）
7. **conversations** - 会話履歴（将来用）
8. **messages** - 会話メッセージ（将来用）

詳細: [migrations/001_init.sql](../migrations/001_init.sql)

---

## 🔌 API設計

### エンドポイント一覧

#### Health Check
- `GET /health` - ヘルスチェック
- `GET /` - API情報

#### Users
- `GET /api/v1/users/me` - ユーザー情報取得

#### Knowledge（コア機能）
- `GET /api/v1/knowledge` - 一覧取得
- `POST /api/v1/knowledge` - 作成
- `GET /api/v1/knowledge/{id}` - 詳細取得
- `PUT /api/v1/knowledge/{id}` - 更新
- `DELETE /api/v1/knowledge/{id}` - 削除
- `GET /api/v1/knowledge/search` - 検索（RAG）

#### Reviews
- `GET /api/v1/reviews` - 履歴取得
- `POST /api/v1/reviews` - レビュー実行
- `GET /api/v1/reviews/{id}` - 詳細取得
- `POST /api/v1/reviews/{id}/feedback` - フィードバック

#### Tags
- `GET /api/v1/tags` - 一覧取得
- `POST /api/v1/tags` - 作成

詳細: [docs/openapi.yaml](openapi.yaml)

---

## 🤖 RAG設計

### Phase 1: キーワード検索

```
┌──────────────┐
│ ユーザー入力  │ コード
└──────┬───────┘
       │
       ▼
┌──────────────────────┐
│ キーワード抽出        │ 関数名、コメント、etc
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│ PostgreSQL全文検索    │ LIKE, to_tsvector
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│ Top-K ナレッジ取得    │ 関連度順
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│ プロンプト生成        │ ナレッジを含む
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│ LLM API呼び出し       │ Claude 3.5 Sonnet
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│ レビュー結果          │
└──────────────────────┘
```

### Phase 2: ベクトル検索

```
┌──────────────┐
│ ユーザー入力  │ コード
└──────┬───────┘
       │
       ▼
┌──────────────────────┐
│ Embedding生成         │ OpenAI API
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│ pgvector検索          │ コサイン類似度
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│ Top-K ナレッジ取得    │ + 類似度スコア
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│ プロンプト生成        │ スコア考慮
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│ LLM API呼び出し       │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│ レビュー結果          │
└──────────────────────┘
```

---

## 📝 プロンプト設計

### システムプロンプトの構造

```
1. 役割定義
   - あなたは{{USER_NAME}}のクローンです

2. 参照ナレッジ
   - カテゴリ、優先度、内容
   - 出典情報（いつ、どこから）

3. レビュー方針
   - 一貫性を保つ
   - 根拠を明示

4. 出力形式
   - 総評 → 良い点 → 改善点 → 根拠
```

詳細: [docs/prompt-design.md](prompt-design.md)

---

## 📊 パフォーマンス目標

| 項目 | Phase 1 | Phase 2 | 備考 |
|------|---------|---------|------|
| **ナレッジ数** | ~100 | ~5000 | 対応可能数 |
| **検索精度** | 70% | 90% | キーワード vs ベクトル |
| **検索速度** | <100ms | <200ms | インデックス最適化 |
| **レビュー生成** | 3-5秒 | 3-5秒 | LLM依存 |
| **コスト/リクエスト** | $0.05 | $0.01 | ナレッジ絞り込み |

---

## 🔐 セキュリティ

### 認証・認可
- JWT認証（Bearer Token）
- ユーザーIDベースのデータ分離
- CORS設定

### データ保護
- パスワードはハッシュ化（Argon2）
- 機密情報は環境変数
- PostgreSQL SSL接続（本番）

---

## 📁 ディレクトリ構造

```
backend/
├── cmd/api/main.go              # エントリーポイント
├── internal/
│   ├── domain/                  # ドメイン層
│   │   ├── model/              # エンティティ
│   │   ├── repository/         # リポジトリIF
│   │   └── service/            # ドメインサービス
│   ├── application/            # アプリケーション層
│   │   └── usecase/           # ユースケース
│   ├── infrastructure/         # インフラ層
│   │   ├── persistence/       # DB実装
│   │   ├── external/          # 外部API
│   │   ├── vector/            # RAG実装
│   │   └── config/            # 設定
│   ├── interfaces/            # インターフェース層
│   │   └── http/             # HTTP API
│   └── di/                    # DI（Wire）
├── migrations/                 # マイグレーション
├── docs/                       # ドキュメント
│   ├── openapi.yaml           # API仕様
│   └── prompt-design.md       # プロンプト設計
├── go.mod
└── go.sum
```

---

## 🧪 テスト戦略

### ユニットテスト
- Domain層: ビジネスロジックのテスト
- Repository: モックを使用
- UseCase: 依存注入でテスト

### 統合テスト
- API エンドポイント
- データベース操作
- LLM API統合

### E2Eテスト
- 実際のユーザーフロー
- レビュー生成の精度

---

## 📚 参考資料

### 設計ドキュメント
- [データベーススキーマ](../migrations/001_init.sql)
- [API仕様書（Swagger）](openapi.yaml)
- [プロンプト設計](prompt-design.md)

### アーキテクチャ
- クリーンアーキテクチャ
- ドメイン駆動設計（DDD）
- 依存性注入（DI）

### 技術ドキュメント
- [Echo Framework](https://echo.labstack.com/)
- [pgvector](https://github.com/pgvector/pgvector)
- [Wire](https://github.com/google/wire)

---