openapi: 3.0.3
info:
  title: ReviewApp API
  description: |
    **ã€Œä½¿ãˆã°ä½¿ã†ã»ã©ã€ã‚ãªãŸã‚‰ã—ããªã‚‹AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã€**
    
    RAGãƒ™ãƒ¼ã‚¹ã®AIã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ„ãƒ¼ãƒ«ã€‚
    ã‚ãªãŸã®ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å“²å­¦ã‚’å­¦ç¿’ã—ã€ä¸€è²«æ€§ã®ã‚ã‚‹ã€Œã‚ãªãŸã‚‰ã—ã„ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æä¾›ã—ã¾ã™ã€‚
    
    ## ä¸»è¦æ©Ÿèƒ½
    - ğŸ“š **ãƒŠãƒ¬ãƒƒã‚¸ç®¡ç†**: ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ«ãƒ¼ãƒ«ãƒ»å“²å­¦ã‚’è“„ç©
    - ğŸ” **RAGæ¤œç´¢**: Phase 1ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼‰ â†’ Phase 2ï¼ˆãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ï¼‰
    - ğŸ’¬ **ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼**: éå»ã®ãƒŠãƒ¬ãƒƒã‚¸ã‚’å‚ç…§ã—ãŸä¸€è²«æ€§ã®ã‚ã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼
    - ğŸ“Š **ãƒ¬ãƒ“ãƒ¥ãƒ¼å±¥æ­´**: ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã§ç²¾åº¦å‘ä¸Š
    
  version: 0.1.0
  contact:
    name: ReviewApp Support
    email: support@reviewapp.example.com
  license:
    name: MIT

servers:
  - url: http://localhost:8080
    description: ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒ
  - url: https://api.reviewapp.example.com
    description: æœ¬ç•ªç’°å¢ƒ

tags:
  - name: Health
    description: ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
  - name: Users
    description: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
  - name: Knowledge
    description: ãƒŠãƒ¬ãƒƒã‚¸ç®¡ç†ï¼ˆã‚³ã‚¢æ©Ÿèƒ½ï¼‰
  - name: Reviews
    description: ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼
  - name: Tags
    description: ã‚¿ã‚°ç®¡ç†

# =====================================================
# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ¼ãƒ 
# =====================================================
security:
  - BearerAuth: []

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWTèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³

  # =====================================================
  # å…±é€šã‚¹ã‚­ãƒ¼ãƒ
  # =====================================================
  schemas:
    # --- ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ ---
    Error:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          example: "invalid_request"
        message:
          type: string
          example: "ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒä¸æ­£ã§ã™"
        details:
          type: object
          additionalProperties: true

    # --- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ ---
    Pagination:
      type: object
      properties:
        page:
          type: integer
          example: 1
        per_page:
          type: integer
          example: 20
        total:
          type: integer
          example: 100
        total_pages:
          type: integer
          example: 5

    # --- User ---
    User:
      type: object
      required:
        - id
        - email
        - name
        - created_at
      properties:
        id:
          type: string
          format: uuid
          example: "123e4567-e89b-12d3-a456-426614174000"
        email:
          type: string
          format: email
          example: "user@example.com"
        name:
          type: string
          example: "å±±ç”°å¤ªéƒ"
        avatar_url:
          type: string
          nullable: true
          example: "https://example.com/avatar.jpg"
        bio:
          type: string
          nullable: true
          example: "Goã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢"
        created_at:
          type: string
          format: date-time
          example: "2024-01-01T00:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2024-01-01T00:00:00Z"

    # --- Knowledge ---
    Knowledge:
      type: object
      required:
        - id
        - user_id
        - title
        - content
        - category
        - priority
        - source_type
        - is_active
        - created_at
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        title:
          type: string
          maxLength: 200
          example: "ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®åŸå‰‡"
        content:
          type: string
          example: "ã‚¨ãƒ©ãƒ¼ã¯å¿…ãšãƒ­ã‚°ã«å‡ºåŠ›ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨é–‹ç™ºè€…å‘ã‘è©³ç´°ã‚’åˆ†ã‘ã‚‹"
        category:
          type: string
          enum:
            - error_handling
            - testing
            - performance
            - security
            - clean_code
            - architecture
            - other
          example: "error_handling"
        priority:
          type: integer
          minimum: 1
          maximum: 5
          example: 5
          description: "é‡è¦åº¦ï¼ˆ1=ä½ã€5=é«˜ï¼‰"
        tags:
          type: array
          items:
            $ref: '#/components/schemas/Tag'
        source_type:
          type: string
          enum:
            - review
            - conversation
            - manual
          example: "manual"
        source_id:
          type: string
          format: uuid
          nullable: true
        is_active:
          type: boolean
          example: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    # --- Knowledge Input ---
    KnowledgeInput:
      type: object
      required:
        - title
        - content
        - category
      properties:
        title:
          type: string
          maxLength: 200
          example: "ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®åŸå‰‡"
        content:
          type: string
          example: "ã‚¨ãƒ©ãƒ¼ã¯å¿…ãšãƒ­ã‚°ã«å‡ºåŠ›ã™ã‚‹"
        category:
          type: string
          example: "error_handling"
        priority:
          type: integer
          minimum: 1
          maximum: 5
          default: 3
        tags:
          type: array
          items:
            type: string
          example: ["go", "error"]

    # --- Review ---
    Review:
      type: object
      required:
        - id
        - user_id
        - code
        - language
        - review_result
        - created_at
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        code:
          type: string
          example: |
            func ProcessData(data string) error {
                if data == "" {
                    return errors.New("empty data")
                }
                return nil
            }
        language:
          type: string
          example: "go"
        file_name:
          type: string
          nullable: true
          example: "handler.go"
        review_result:
          type: string
          example: "ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒé©åˆ‡ã§ã™ã€‚ãŸã ã—ã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã¯ã‚‚ã†å°‘ã—è©³ç´°ã‚’å«ã‚ã‚‹ã¨ãƒ‡ãƒãƒƒã‚°ã—ã‚„ã™ããªã‚Šã¾ã™ã€‚"
        referenced_knowledge:
          type: array
          items:
            $ref: '#/components/schemas/Knowledge'
          description: "ãƒ¬ãƒ“ãƒ¥ãƒ¼æ™‚ã«å‚ç…§ã•ã‚ŒãŸãƒŠãƒ¬ãƒƒã‚¸"
        llm_provider:
          type: string
          example: "claude"
        llm_model:
          type: string
          example: "claude-3-5-sonnet-20241022"
        tokens_used:
          type: integer
          nullable: true
          example: 1250
        feedback_score:
          type: integer
          nullable: true
          minimum: 1
          maximum: 5
          description: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆ1=æ‚ªã„ã€5=è‰¯ã„ï¼‰"
        feedback_comment:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    # --- Review Input ---
    ReviewInput:
      type: object
      required:
        - code
        - language
      properties:
        code:
          type: string
          example: |
            func ProcessData(data string) error {
                if data == "" {
                    return errors.New("empty data")
                }
                return nil
            }
        language:
          type: string
          example: "go"
        file_name:
          type: string
          example: "handler.go"

    # --- Tag ---
    Tag:
      type: object
      required:
        - id
        - name
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          example: "go"
        color:
          type: string
          pattern: '^#[0-9A-Fa-f]{6}$'
          example: "#3178C6"
        created_at:
          type: string
          format: date-time

# =====================================================
# Pathsï¼ˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼‰
# =====================================================
paths:
  # =====================================================
  # Health Check
  # =====================================================
  /health:
    get:
      tags:
        - Health
      summary: ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
      description: APIã‚µãƒ¼ãƒãƒ¼ã®çŠ¶æ…‹ã‚’ç¢ºèª
      security: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "ok"
                  service:
                    type: string
                    example: "ReviewApp API"

  /:
    get:
      tags:
        - Health
      summary: ãƒ«ãƒ¼ãƒˆ
      description: APIæƒ…å ±ã‚’å–å¾—
      security: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "ReviewApp API"
                  version:
                    type: string
                    example: "0.1.0"

  # =====================================================
  # Users
  # =====================================================
  /api/v1/users/me:
    get:
      tags:
        - Users
      summary: ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: æœªèªè¨¼
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # =====================================================
  # Knowledgeï¼ˆãƒŠãƒ¬ãƒƒã‚¸ç®¡ç† - ã‚³ã‚¢æ©Ÿèƒ½ï¼‰
  # =====================================================
  /api/v1/knowledge:
    get:
      tags:
        - Knowledge
      summary: ãƒŠãƒ¬ãƒƒã‚¸ä¸€è¦§ã‚’å–å¾—
      parameters:
        - name: category
          in: query
          description: ã‚«ãƒ†ã‚´ãƒªã§ãƒ•ã‚£ãƒ«ã‚¿
          schema:
            type: string
            example: "error_handling"
        - name: tag
          in: query
          description: ã‚¿ã‚°ã§ãƒ•ã‚£ãƒ«ã‚¿
          schema:
            type: string
            example: "go"
        - name: priority
          in: query
          description: å„ªå…ˆåº¦ã§ãƒ•ã‚£ãƒ«ã‚¿
          schema:
            type: integer
            minimum: 1
            maximum: 5
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: per_page
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Knowledge'
                  pagination:
                    $ref: '#/components/schemas/Pagination'

    post:
      tags:
        - Knowledge
      summary: ãƒŠãƒ¬ãƒƒã‚¸ã‚’ä½œæˆ
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/KnowledgeInput'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Knowledge'
        '400':
          description: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/knowledge/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid
    
    get:
      tags:
        - Knowledge
      summary: ãƒŠãƒ¬ãƒƒã‚¸ã‚’å–å¾—
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Knowledge'
        '404':
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      tags:
        - Knowledge
      summary: ãƒŠãƒ¬ãƒƒã‚¸ã‚’æ›´æ–°
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/KnowledgeInput'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Knowledge'
        '404':
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      tags:
        - Knowledge
      summary: ãƒŠãƒ¬ãƒƒã‚¸ã‚’å‰Šé™¤
      responses:
        '204':
          description: No Content
        '404':
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/knowledge/search:
    get:
      tags:
        - Knowledge
      summary: ãƒŠãƒ¬ãƒƒã‚¸ã‚’æ¤œç´¢
      description: |
        **Phase 1**: ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ï¼ˆå…¨æ–‡æ¤œç´¢ï¼‰
        **Phase 2**: ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ï¼ˆæ„å‘³çš„é¡ä¼¼åº¦ï¼‰
      parameters:
        - name: q
          in: query
          required: true
          description: æ¤œç´¢ã‚¯ã‚¨ãƒª
          schema:
            type: string
            example: "ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°"
        - name: limit
          in: query
          schema:
            type: integer
            default: 5
            maximum: 20
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      type: object
                      allOf:
                        - $ref: '#/components/schemas/Knowledge'
                        - type: object
                          properties:
                            relevance_score:
                              type: number
                              format: float
                              description: "é–¢é€£åº¦ã‚¹ã‚³ã‚¢ï¼ˆPhase 2ã§ä½¿ç”¨ï¼‰"
                              example: 0.92
                  search_method:
                    type: string
                    enum: [keyword, vector]
                    description: "ä½¿ç”¨ã•ã‚ŒãŸæ¤œç´¢æ–¹æ³•"
                    example: "keyword"

  # =====================================================
  # Reviewsï¼ˆã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰
  # =====================================================
  /api/v1/reviews:
    get:
      tags:
        - Reviews
      summary: ãƒ¬ãƒ“ãƒ¥ãƒ¼å±¥æ­´ã‚’å–å¾—
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: per_page
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Review'
                  pagination:
                    $ref: '#/components/schemas/Pagination'

    post:
      tags:
        - Reviews
      summary: ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œ
      description: |
        RAGã®æ ¸å¿ƒæ©Ÿèƒ½:
        1. é–¢é€£ãƒŠãƒ¬ãƒƒã‚¸ã‚’æ¤œç´¢
        2. ãƒŠãƒ¬ãƒƒã‚¸ã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å«ã‚ã¦LLMå‘¼ã³å‡ºã—
        3. ä¸€è²«æ€§ã®ã‚ã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç”Ÿæˆ
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReviewInput'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Review'
        '400':
          description: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: LLM APIã‚¨ãƒ©ãƒ¼
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/reviews/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid
    
    get:
      tags:
        - Reviews
      summary: ãƒ¬ãƒ“ãƒ¥ãƒ¼è©³ç´°ã‚’å–å¾—
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Review'
        '404':
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/reviews/{id}/feedback:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid
    
    post:
      tags:
        - Reviews
      summary: ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’é€ä¿¡
      description: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã§ç²¾åº¦å‘ä¸Š
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - score
              properties:
                score:
                  type: integer
                  minimum: 1
                  maximum: 5
                  description: "1=æ‚ªã„ã€5=è‰¯ã„"
                comment:
                  type: string
                  description: "ä»»æ„ã®ã‚³ãƒ¡ãƒ³ãƒˆ"
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸ"
        '404':
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # =====================================================
  # Tagsï¼ˆã‚¿ã‚°ç®¡ç†ï¼‰
  # =====================================================
  /api/v1/tags:
    get:
      tags:
        - Tags
      summary: ã‚¿ã‚°ä¸€è¦§ã‚’å–å¾—
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Tag'

    post:
      tags:
        - Tags
      summary: ã‚¿ã‚°ã‚’ä½œæˆ
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
                  example: "go"
                color:
                  type: string
                  pattern: '^#[0-9A-Fa-f]{6}$'
                  example: "#3178C6"
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Tag'
        '409':
          description: ã‚¿ã‚°ãŒæ—¢ã«å­˜åœ¨
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
